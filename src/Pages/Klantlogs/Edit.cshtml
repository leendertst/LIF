@page
@using Lif.Models
@model Lif.Pages.Klantlogs.EditModel
@{
    ViewData["Title"] = $"Bewerk Klantlog Week {Model.Klantlog.WeekNummer}";
}

<div class="page-header mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a asp-page="Index">
                    <i class="bi bi-clipboard-check"></i> Klantlogs
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Bewerken</li>
        </ol>
    </nav>
    <h1><i class="bi bi-pencil-square"></i> Bewerk Klantlog Week @Model.Klantlog.WeekNummer - @Model.Klantlog.Jaar</h1>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="row">
    <div class="col-md-8">
        <!-- Klantlog Info Card -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Klantlog Informatie
                </h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">
                        <i class="bi bi-person me-2"></i>Klant
                    </dt>
                    <dd class="col-sm-8">
                        @Model.Klantlog.User.Email
                    </dd>

                    <dt class="col-sm-4">
                        <i class="bi bi-calendar-week me-2"></i>Week / Jaar
                    </dt>
                    <dd class="col-sm-8">
                        Week @Model.Klantlog.WeekNummer van @Model.Klantlog.Jaar
                    </dd>

                    <dt class="col-sm-4">
                        <i class="bi bi-calendar me-2"></i>Datum
                    </dt>
                    <dd class="col-sm-8">
                        @Model.Klantlog.Datum.ToString("dddd d MMMM yyyy")
                    </dd>

                    <dt class="col-sm-4">
                        <i class="bi bi-shield-check me-2"></i>Status
                    </dt>
                    <dd class="col-sm-8">
                        @{
                            var statusBadge = Model.Klantlog.Status switch
                            {
                                KlantlogStatus.Concept => "bg-secondary",
                                KlantlogStatus.Definitief => "bg-success",
                                KlantlogStatus.Afgerond => "bg-info",
                                KlantlogStatus.Geannuleerd => "bg-danger",
                                _ => "bg-secondary"
                            };
                        }
                        <span class="badge @statusBadge">@Model.Klantlog.Status</span>
                    </dd>
                </dl>
            </div>
        </div>

        <!-- Producten Card -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-box-seam"></i> Producten
                </h5>
            </div>
            <div class="card-body">
                @if (Model.Klantlog.KlantlogProducten.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th class="text-center">Aantal</th>
                                    <th class="text-end">Prijs per stuk</th>
                                    <th class="text-end">Totaal</th>
                                    <th class="text-center">Acties</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var klantlogProduct in Model.Klantlog.KlantlogProducten.OrderBy(kp => kp.Product.Naam))
                                {
                                    <tr>
                                        <td>
                                            <strong>@klantlogProduct.Product.Naam</strong>
                                            @if (!string.IsNullOrEmpty(klantlogProduct.Product.Beschrijving))
                                            {
                                                <br />
                                                <small class="text-muted">@klantlogProduct.Product.Beschrijving</small>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-primary">@klantlogProduct.Aantal</span>
                                        </td>
                                        <td class="text-end">
                                            @klantlogProduct.Product.Prijs.ToString("C")
                                        </td>
                                        <td class="text-end">
                                            <strong>@((klantlogProduct.Aantal * klantlogProduct.Product.Prijs).ToString("C"))</strong>
                                        </td>
                                        <td class="text-center">
                                            <form method="post" asp-page-handler="VerwijderProduct" 
                                                  asp-route-productId="@klantlogProduct.ProductId"
                                                  class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-danger"
                                                        onclick="return confirm('Weet je zeker dat je dit product wilt verwijderen?')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <td colspan="3" class="text-end"><strong>Totaalprijs:</strong></td>
                                    <td class="text-end">
                                        <strong class="fs-5 text-success">@Model.Klantlog.TotaalPrijs.ToString("C")</strong>
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Er zijn nog geen producten toegevoegd. Voeg hieronder producten toe.
                    </div>
                }
            </div>
        </div>

        <!-- Voeg Product Toe Card -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-plus-circle"></i> Product Toevoegen
                </h5>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="VoegProductToe">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                    
                    <div class="row g-3">
                        <div class="col-md-7">
                            <label asp-for="ToTeVoegenProductId" class="form-label">
                                <i class="bi bi-box"></i> Product
                            </label>
                            <select asp-for="ToTeVoegenProductId" class="form-select" required>
                                <option value="">-- Selecteer een product --</option>
                                @foreach (var product in Model.BeschikbareProducten)
                                {
                                    <option value="@product.Value">@product.Text</option>
                                }
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label asp-for="ToTeVoegenAantal" class="form-label">
                                <i class="bi bi-123"></i> Aantal
                            </label>
                            <input asp-for="ToTeVoegenAantal" type="number" class="form-control" min="1" value="1" required />
                        </div>
                        
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-plus"></i> Toevoegen
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Opmerkingen Card -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-chat-left-text"></i> Opmerkingen
                </h5>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="UpdateOpmerkingen">
                    <input type="hidden" asp-for="Klantlog.Id" />
                    
                    <div class="mb-3">
                        <textarea asp-for="Klantlog.Opmerkingen" class="form-control" rows="4" 
                                  placeholder="Voeg eventuele opmerkingen toe..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Opmerkingen Opslaan
                    </button>
                </form>
            </div>
        </div>

        <!-- Acties -->
        <div class="d-flex gap-2">
            <a asp-page="Details" asp-route-id="@Model.Klantlog.Id" class="btn btn-info">
                <i class="bi bi-eye"></i> Bekijk Details
            </a>
            <a asp-page="Index" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Terug naar Overzicht
            </a>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Samenvatting Card -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="bi bi-bar-chart"></i> Samenvatting
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <span><i class="bi bi-box-seam text-primary"></i> Aantal producten:</span>
                    <strong>@Model.Klantlog.KlantlogProducten.Count</strong>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span><i class="bi bi-123 text-primary"></i> Totaal items:</span>
                    <strong>@Model.Klantlog.KlantlogProducten.Sum(kp => kp.Aantal)</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span><i class="bi bi-currency-euro text-success"></i> Totaalprijs:</span>
                    <strong class="text-success fs-5">@Model.Klantlog.TotaalPrijs.ToString("C")</strong>
                </div>
            </div>
        </div>

        <!-- Instructies Card -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="bi bi-lightbulb"></i> Tips
                </h6>
            </div>
            <div class="card-body">
                <ul class="mb-0 small">
                    <li class="mb-2">Voeg alle gewenste producten toe voordat je de klantlog definitief maakt</li>
                    <li class="mb-2">Je kunt hetzelfde product meerdere keren toevoegen - de aantallen worden opgeteld</li>
                    <li class="mb-2">Opmerkingen kunnen bijzondere wensen of instructies bevatten</li>
                    <li>Een definitieve klantlog kan niet meer bewerkt worden</li>
                </ul>
            </div>
        </div>

        <!-- Status Uitleg Card -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i> Status Informatie
                </h6>
            </div>
            <div class="card-body">
                <p class="mb-3">
                    <span class="badge bg-secondary">Concept</span>
                    <small class="d-block mt-1">
                        Je kunt producten toevoegen en verwijderen. Nog niet verzonden.
                    </small>
                </p>
                
                <hr />
                
                <p class="mb-0">
                    Wanneer je klaar bent, ga dan naar het detail scherm om de klantlog definitief te maken.
                </p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}